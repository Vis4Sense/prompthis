# Diffusion

```bash
ðŸ“‚diffusion
 â”£ ðŸ“‚models              - Diffusion models
 â”£ ðŸ“‚handlers            - Request handlers
 â”£ ðŸ“‚outputs             - Prompt data and generated images
 â”£ ðŸ“‚utils
 â”£ ðŸ“‚tests
 â”£ ðŸ“œapp.py
 â”£ ðŸ“œmodels.yaml
 â”— ðŸ“œREADME.md
```

## Features

- Generate images by requesting text-to-image APIs and is applicable to various types of text-to-image models. Therefore, images in a thread can be generated by different models.
- Document all logs, including complete context information, request settings, and outputs.
- Able to handle request stream without having to wait for completion of image generation before accepting the next request
  - When there are too many requests, the system would not accept the upcoming ones and report "system is busy"
- Support extensions for preprocessing log data

## Query format

`/create/txt2img`

```json
{
    "user_id": "t0",
    "thread_id": "t0",
    "model": "stable-diffusion-webui",
    "settings": {
        "prompt": "this is an example prompt",
        "steps": 20
    }
}
```

`model` and `settings` are necessary. `user_id` and `thread_id` are optional. If there is no `user_id` or `thread_id`, the log will be saved in cache.

## Log format

Settings and generated images are saved in `./outputs/`

```plaintext
ðŸ“‚outputs
 â”£ ðŸ“‚{user_id1}             - user id
 â”ƒ â”£ ðŸ“‚{u1_thread_id1}      - thread id
 â”ƒ â”£ ðŸ“‚{u1_thread_id2}
 â”ƒ â”£ ðŸ“‚...
 â”ƒ â”— ðŸ“œlog.csv              - log of threads of each user
 â”£ ðŸ“‚{user_id2}
 â”ƒ â”£ ðŸ“‚...
 â”ƒ â”— ðŸ“œlog.csv
 â”£ ðŸ“‚...
 â”— ðŸ“œusers.csv              - meta data of users
```

For each thread, the log data is saved in the following format:

```plaintext
ðŸ“‚{thread_id}
 â”£ ðŸ“‚data                    - complete settings and images
 â”ƒ â”£ ðŸ“œ{iterid1}.json        - settings
 â”ƒ â”£ ðŸ“œ{iter1imgid1}.png     - generated image
 â”ƒ â”£ ðŸ“œ{iter1imgid2}.png
 â”ƒ â”£ ðŸ“œ...
 â”ƒ â”£ ðŸ“œ{iterid2}.json
 â”ƒ â”— ðŸ“œ...
 â”— ðŸ“œlog.csv
```

Schema of thread log

| Attribute        | Description                  |
| ---------------- | ---------------------------- |
| prompt_id        | id of the prompt             |
| model            | name of the model            |
| create_time      | time of receiving query      |
| create_timezone  | timezone of create time      |
| finish_time      | time of finishing generation |
| finish_timezone  | timezone of finish time      |
| width            | image width                  |
| height           | image height                 |
| steps            | steps                        |
| batch_size       | batch size                   |
| prompt           | positive prompt              |
| negative_prompt  | negative prompt              |
| setting_filename | setting filename             |
| output_filenames | list of the output filenames |
| ratings          | list of user ratings         |

## Fetch log data

`/fetch/log`

The diffusion app provides APIs for fetching saved records. Temporarily it uses the same configuration with the extensions (see [preprocess data](#preprocess-data)), sepcifically the settings for reading input data (`data`, `input`, `output`).

An example query for fetching the session log data is like:

```json
{
    "dsl": {
        "data": {
            "user_id": user_id,
            "thread_id": thread_id,
        },
        "input": [
            {
                "attribute": "log/log",
                "filter": "all",
            },
            {
                "attribute": "log/image",
                "filter": "all",
            },
            {
                "attribute": "preprocess/image_projection",
                "filter": "latest"
            }
        ],
        "output": "latest-log/prompt-json"
    }
}
```

## Preprocess data

Request extension APIs to preprocess data.

The processed data is saved in an additional sub-directory named `processed` in the given log directory.

```plaintext
ðŸ“‚{thread_id}
 â”£ ðŸ“‚data                - complete settings and images
 â”£ ðŸ“‚processed           - preprocessed results
 â”— ðŸ“œlog.csv
```

### DSL

Preprocess: image encoding

```json
{
    "extension_name": "preprocess",
    "task": "image_encoding",
    "url": "",
    "data": { "object": "thread", "user_id": 0, "thread_id": 0 },
    "input": [
        {
            "attribute": "log/image",
            "filter": "unprocessed" // unprocessed | latest | all
        }
    ],
    "output": "map-log/image"
}
```

Preprocess: image projection

```json
{
    "extension_name": "preprocess",
    "task": "image_projection",
    "url": "",
    "data": { "object": "thread", "user_id": 0, "thread_id": 0 },
    "input": [
        {
            "attribute": "preprocess/image_encoding",
            "filter": "all"
        },
        {
            "attribute": "preprocess/image_projection",
            "filter": "latest"
        }
    ],
    "output": "latest-log/prompt"
}
```

### DSL to API

The input data can be

- log.csv
- log data
- preprocessed data

API format

```json
{
    "input": [
        {
            ""
        }
    ]
}
```

## Local models

Stable Diffusion

- Stable Diffusion web UI
  - [github](https://github.com/AUTOMATIC1111/stable-diffusion-webui)
